{% extends "base.html" %}
{% block content %}
<nav class="crumb">
  <a href="{{ url_for('main.projects') }}">โปรเจกต์ของฉัน</a> ›
  <a href="{{ url_for('main.project_detail', project_id=task.project_id) }}">โปรเจกต์ {{ task.project_id }}</a> ›
  <span>{{ task.title }}</span>
</nav>

<h1>{{ task.title }}</h1>

<section class="card big">
  <div class="row2">
    <div>
      <p class="muted">สถานะ: <span class="badge {{ task.status }}">{{ task.status }}</span></p>
    </div>
    <div class="right">
      {% if is_manager %}
      <form class="inline" method="post" action="{{ url_for('tasks.change_status', task_id=task.id) }}">
        <select class="lg" name="status">
          <option value="todo" {{ 'selected' if task.status=='todo' else '' }}>todo</option>
          <option value="doing" {{ 'selected' if task.status=='doing' else '' }}>doing</option>
          <option value="done" {{ 'selected' if task.status=='done' else '' }}>done</option>
          <option value="blocked" {{ 'selected' if task.status=='blocked' else '' }}>blocked</option>
        </select>
        <button class="ghost xl" type="submit">อัปเดตสถานะ</button>
      </form>
      <form class="inline" method="post" action="{{ url_for('tasks.change_progress', task_id=task.id) }}">
        <input class="lg" type="number" min="0" max="100" name="progress" value="{{ task.progress_percent }}">
        <button class="ghost xl" type="submit">อัปเดต %</button>
      </form>
      {% else %}
      <p class="muted">ความคืบหน้า: {{ task.progress_percent }}% • (แก้ไขได้โดย owner/ba)</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card big">
  <h3>โพสต์อัปเดตใหม่</h3>
  <form method="post" action="{{ url_for('tasks.create_update', task_id=task.id) }}">
    <label>รายละเอียดอัปเดต</label>
    <textarea class="lg" name="content" rows="3" required placeholder="เขียนว่าทำอะไรคืบหน้าไปบ้าง..."></textarea>

    {% if is_manager %}
    <div class="row2">
      <div>
        <label>ความคืบหน้า (%)</label>
        <input class="lg" type="number" name="progress_percent" min="0" max="100" placeholder="0-100">
      </div>
      <div>
        <label>สถานะ</label>
        <select class="lg" name="status">
          <option value="">(ไม่เปลี่ยน)</option>
          <option value="todo">todo</option>
          <option value="doing">doing</option>
          <option value="done">done</option>
          <option value="blocked">blocked</option>
        </select>
      </div>
    </div>
    {% endif %}

    <label>แนบลิงก์ (หนึ่งบรรทัดต่อ 1 ลิงก์)</label>
    <textarea class="lg" name="links" rows="2" placeholder="https://github.com/...&#10;https://figma.com/..."></textarea>

    <p class="muted">หากต้องแนบไฟล์ ให้ไปอัปโหลดใต้โพสต์หลังจากโพสต์นี้สำเร็จ</p>
    <button class="cta xl" type="submit">โพสต์อัปเดต</button>
  </form>
</section>

<section class="card big">
  <h3>ไทม์ไลน์อัปเดต (ล่าสุดอยู่บน)</h3>
  <ul class="updates">
    {% for u in updates %}
    <li class="update-card">
      <div class="up-top">
        {% if u.status %}<span class="badge {{ u.status }}">{{ u.status }}</span>{% endif %}
        {% if u.progress_percent is not none %}<span class="chip">Progress: {{ u.progress_percent }}%</span>{% endif %}
        <span class="muted right">{{ u.created_at }}</span>
      </div>

      <div class="up-content">{{ u.content }}</div>

      {# ===== รายการลิงก์ของโพสต์ ===== #}
      {% set links = links_map.get(u.id, []) %}
      {% if links %}
      <div class="links">
        {% for l in links %}
          <a class="link-pill" href="{{ l.url }}" target="_blank">{{ l.url }}</a>
        {% endfor %}
      </div>
      {% endif %}

      {# ===== อัปโหลดไฟล์ใต้โพสต์นี้ ===== #}
      <div class="upload-under-update" style="margin-top:10px;">
        <label class="muted">แนบไฟล์ให้โพสต์นี้ (png, jpg/jpeg, pdf, docx, xlsx ≤ 10MB/ไฟล์)</label><br>
        <input class="lg" id="fileInput-{{ u.id }}" type="file" multiple>
        <button class="ghost small" onclick="uploadForUpdate({{ u.id }})">อัปโหลด</button>
        <span id="uploadStatus-{{ u.id }}" class="muted" style="margin-left:8px;"></span>
      </div>

      {# ===== แสดงไฟล์ที่แนบกับโพสต์นี้ ===== #}
      {% set f_list = (files_by_update.get(u.id) or []) %}
      <ul class="files" style="margin-top:8px;">
        {% for f in f_list %}
        <li>
          <a href="{{ f.secure_url }}" target="_blank">{{ f.file_name }}</a>
          <span class="muted">• {{ f.content_type or '?' }} • {{ f.size_bytes or 0 }} bytes</span>
          <form method="post" action="{{ url_for('tasks.delete_file', task_id=task.id, file_id=f.id) }}" style="display:inline">
            <button class="danger small" type="submit">ลบ</button>
          </form>
        </li>
        {% else %}
        <li class="muted">ยังไม่มีไฟล์แนบในโพสต์นี้</li>
        {% endfor %}
      </ul>

      <a class="ghost small" href="{{ url_for('tasks.update_detail', update_id=u.id) }}">ดูรายละเอียด</a>
    </li>
    {% else %}
    <li class="muted">ยังไม่มีโพสต์อัปเดต</li>
    {% endfor %}
  </ul>
</section>

<script>
async function uploadForUpdate(updateId){
  const cloud = "{{ cloudinary_cloud_name or '' }}";
  const preset = "{{ cloudinary_upload_preset or '' }}";
  if(!cloud || !preset){ alert("ยังไม่ได้ตั้งค่า Cloudinary"); return; }

  const fi = document.getElementById('fileInput-' + updateId);
  const files = fi.files;
  if(!files || files.length===0){ alert("เลือกไฟล์ก่อน"); return; }

  const allowed = [
    'image/png','image/jpeg','application/pdf',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  ];

  const status = document.getElementById('uploadStatus-' + updateId);
  status.textContent = "กำลังอัปโหลด...";

  for (const f of files){
    if (!allowed.includes(f.type) && !f.name.toLowerCase().match(/\.(png|jpg|jpeg|pdf|docx|xlsx)$/)) {
      alert("ชนิดไฟล์ไม่รองรับ: " + f.name);
      continue;
    }
    if (f.size > 10*1024*1024) {
      alert("ไฟล์ใหญ่เกินกำหนด (≤10MB): " + f.name);
      continue;
    }

    const url = `https://api.cloudinary.com/v1_1/${cloud}/auto/upload`;
    const fd = new FormData();
    fd.append('file', f);
    fd.append('upload_preset', preset);

    const up = await fetch(url, { method: 'POST', body: fd });
    const js = await up.json();
    if(js.secure_url){
      const regFd = new FormData();
      regFd.append('file_name', f.name);
      regFd.append('content_type', f.type || '');
      regFd.append('size_bytes', f.size.toString());
      regFd.append('public_id', js.public_id || '');
      regFd.append('secure_url', js.secure_url);
      regFd.append('task_update_id', updateId.toString());
      const reg = await fetch("{{ url_for('tasks.register_uploaded_file', task_id=task.id) }}", {
        method: 'POST',
        body: regFd
      });
      const rjs = await reg.json();
      if(!rjs.ok){ console.log(rjs); alert("บันทึกไฟล์ในระบบไม่สำเร็จ: "+(rjs.error||'')); }
    }else{
      console.log(js); alert("อัปโหลดไป Cloudinary ไม่สำเร็จ: "+(js.error && js.error.message));
    }
  }
  status.textContent = "อัปโหลดเสร็จ ✓ กำลังรีเฟรชหน้า...";
location.reload();
}
</script>
{% endblock %}
